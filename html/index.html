<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="./echarts.min.js"></script>
    <script src="./map_data.js"></script>
    <script src="./jquery-3.6.0.min.js"></script>
</head>

<body>
    <div id="main" style="width: 100vw;height:400px;"></div>
</body>
<script type="text/javascript">
    // 基于准备好的dom，初始化echarts实例
    var myChart = echarts.init(document.getElementById('main'))

    // 色彩
    var colorList = [
        '#ff8080', '#0080ff', '#8080ff', '#30EE30', '#feb400', '#feb400', '#EEEEEE'
    ];


    var now_key = 0
    var now_beat = 0
    // 谱面时长
    // var map_time = 3 * 60 + 40
    var map_time = 60 * 3
    var bpm = 340
    // 按键数量
    var key_total = 6

    // 初始化数据
    var data = []
    var beat = 0
    console.log(map_time * bpm / 60)
    while (beat < map_time / 60 * bpm) {
        beat++
        beat_at_time = beat * 60 / bpm
        for (var num = 0; num < key_total; num++) {
            data.push([
                beat_at_time, num, false, beat
            ])
        }
    }

    var time_data = []
    var now_time = 0
    while (now_time < map_time) {
        time_data.push([now_time, -1])
        now_time++
    }
    console.log(time_data)

    // 指定图表的配置项和数据
    var option = {
        xAxis: [
            {   // bpm轴
                show: true,
                type: "value",
                interval: 60 / bpm,
                axisLabel: {
                    show: true,
                    rotate: -45,
                    formatter: function (value) {
                        // return (value / (60 / bpm)).toFixed()
                        if ((value / (60 / bpm)).toFixed() % 10 == 0) {
                            return (value / (60 / bpm)).toFixed()
                        } else {

                        }
                    },
                }
            },
            {   // 时间轴
                show: true,
                type: "value",
                position: "top",
                interval: 1,
                alignTicks: true,
                axisLabel: {
                    show: true,
                    formatter: function (value) {
                        return second_to_string(value)
                    },
                }
            }
        ],
        yAxis: {
            splitLine: {
                show: true,
            },
            type: "category",
            data: ["圆圈", "叉叉", "方框", "三角", "向左", "向右"],
        },
        series: [
            {
                symbolSize: 10,
                data: data,
                type: 'scatter',
                symbol: function (value, params) {
                    return "rect"
                    if (!value[2]) {
                        return "rect"
                    }
                },
                symbolSize: [
                    10, 30
                ],
                itemStyle: {
                    normal: {
                        color: function (params) {
                            if (!params.data[2]) {
                                return colorList[colorList.length - 1]
                            }
                            return colorList[params.data[1]]
                        }
                    }
                }
            }, {
                symbolSize: 10,
                xAxisIndex: 1,
                data: time_data,
                type: 'scatter',
            }
        ],
        tooltip: {
            show: true,
            formatter: function (params) {
                now_time = second_to_string(params.data[0])
                now_key = params.data[1]
                now_beat = params.data[3]
                return `<div style='color:${colorList[params.data[1]]}'>
                            ${params.name} 
                            ${now_time}
                            ${now_beat}
                        </div>`
            }
        },
        dataZoom: [{
            xAxisIndex: [0, 1],
            endValue: 10
        }]
    };

    // 使用刚指定的配置项和数据显示图表。
    myChart.setOption(option)

    // 事件
    myChart.on('click', 'series', function (params) {
        var key = params.value[1]
        var bpm = params.value[3]
        var index = key + (bpm - 1) * key_total
        option.series[0].data[index][2] = !option.series[0].data[index][2]
        myChart.setOption(option);
    });
    var mouse_down_index = 0;
    myChart.on('mousedown', 'series', function (params) {
        var key = params.value[1]
        var bpm = params.value[3]
        event_start_index = key + (bpm - 1) * key_total
    });
    myChart.on('mouseup', 'series', function (params) {
        var key = params.value[1]
        var bpm = params.value[3]
        event_end_index = key + (bpm - 1) * key_total
        console.log(event_end_index)
        console.log(event_start_index)
        mouse_down_index = 0
        // option.series[0].data[mouse_down_index][2] = !option.series[0].data[mouse_down_index][2]

    });
    $("#main").mousedown(function () {
        mousedown_flag = true
    })
    $("#main").mouseup(function () {
        mousedown_flag = false
    })

    // 工具函数
    // 秒数格式化
    function second_to_string(second_num) {
        var minute = parseInt(second_num / 60)
        var second = parseInt(second_num - minute * 60)
        second = second < 10 ? "0" + second : second
        return minute + ":" + second
    }
</script>

</html>